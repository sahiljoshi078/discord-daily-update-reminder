name: AF Monthly Payment Reminder (Nepali 7th)

on:
  schedule:
    - cron: "15 3 * * *"   # Daily 09:00 Nepal time (03:15 UTC)
  workflow_dispatch:
    inputs:
      force_send:
        description: "Send message even if today is not Nepali 7th"
        required: false
        default: "false"

jobs:
  send-message:
    runs-on: ubuntu-latest
    steps:
      - name: Install nepali-datetime
        run: |
          python -m pip install --upgrade pip
          pip install nepali-datetime

      - name: Check Nepali day-of-month == 7
        id: nepdate
        env:
          FORCE_SEND: ${{ github.event.inputs.force_send }}
        run: |
          python - << 'PY'
          import os
          import nepali_datetime

          bs = nepali_datetime.date.today()
          force = (os.getenv("FORCE_SEND", "false").lower() == "true")
          send = force or (bs.day == 7)

          print("Nepali date:", bs, "force:", force, "send:", send)

          out = os.environ["GITHUB_OUTPUT"]
          with open(out, "a") as f:
              f.write(f"send={'true' if send else 'false'}\n")
          PY

      - name: Send AF payment reminder
        if: steps.nepdate.outputs.send == 'true'
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL_AF }}
        run: |
          NEP_MONTH=$(python - << 'PY'
          import nepali_datetime
          print(nepali_datetime.date.today().strftime("%B"))
          PY
          )

          curl --fail -H "Content-Type: application/json" \
          -X POST \
          -d "{\"content\":\"AF: Monthly payment reminder â€“ ${NEP_MONTH} (Nepali date 7) ðŸ’°\"}" \
          "$WEBHOOK"
